<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’‘ ê²°í˜¼ ì¤€ë¹„ ì˜ˆì‚° ê´€ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        .header {
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .header h1 { font-size: 24px; font-weight: bold; margin-bottom: 8px; }
        .header-subtitle { font-size: 14px; opacity: 0.9; }
        .header-note { font-size: 12px; opacity: 0.75; margin-top: 8px; }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-white { background: white; color: #a855f7; }
        .btn-white:hover { opacity: 0.9; }
        .btn-purple { background: #a855f7; color: white; width: 100%; padding: 10px; }
        .btn-purple:hover { background: #9333ea; }
        .btn-green { background: #10b981; color: white; padding: 8px 16px; margin-left: 8px; }
        .btn-green:hover { background: #059669; }
        .btn-add {
            width: 100%;
            padding: 16px;
            background: white;
            border: 2px dashed #a855f7;
            border-radius: 12px;
            color: #a855f7;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            cursor: pointer;
        }
        .btn-add:hover { background: #f3e8ff; }
        
        .tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .tab {
            flex: 1;
            padding: 16px;
            border: none;
            background: none;
            font-weight: 600;
            cursor: pointer;
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        .tab.active { color: #a855f7; border-bottom-color: #a855f7; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .card-gradient {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-gradient-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-label { font-size: 14px; opacity: 0.9; margin-bottom: 4px; }
        .card-amount { font-size: 32px; font-weight: bold; }
        .card-note { 
            font-size: 12px; 
            opacity: 0.75; 
            margin-top: 8px; 
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .card-note-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        
        .item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: start;
        }
        .item.checked { background: #f0fdf4; border-color: #86efac; }
        .item-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 4px;
        }
        .item.checked .item-checkbox { background: #10b981; border-color: #10b981; color: white; }
        .item-content { flex: 1; }
        .item-header { display: flex; gap: 8px; margin-bottom: 4px; align-items: center; }
        .item-date { font-size: 14px; color: #6b7280; }
        .item.checked .item-date { text-decoration: line-through; color: #9ca3af; }
        .item-category {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .item.checked .item-category { opacity: 0.5; }
        .item-amount {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 4px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #ef4444;
        }
        .item-amount.zero { color: #6b7280; }
        .item.checked .item-amount { text-decoration: line-through; }
        .item-note { font-size: 14px; color: #6b7280; }
        .item.checked .item-note { text-decoration: line-through; color: #9ca3af; }
        .item-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .item-edit, .item-delete {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            flex-shrink: 0;
        }
        .item-edit:hover { background: #f3f4f6; }
        .item-delete:hover { background: #fee2e2; }
        
        .form-card {
            background: white;
            border: 2px solid #a855f7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .form-title { font-size: 18px; font-weight: bold; color: #a855f7; }
        .form-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
        }
        .form-close:hover { color: #a855f7; }
        .form-group { margin-bottom: 12px; }
        .form-label { 
            font-size: 14px; 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 6px; 
            display: block; 
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-input:focus { outline: none; border-color: #a855f7; }
        
        .content { padding: 16px; }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 12px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sync-status.syncing { color: #3b82f6; }
        .sync-status.synced { color: #10b981; }
        .sync-status.error { color: #ef4444; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="syncStatus" class="sync-status syncing">ğŸ”„ ì—°ê²° ì¤‘...</div>
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="form-header">
                <div class="form-title">í†µì¥ ì •ë³´ ìˆ˜ì •</div>
                <button class="form-close" onclick="window.closeEditModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ’° í†µì¥ ì”ì•¡ (í˜„ì¬ ì”ì•¡)</label>
                <input type="number" id="editCurrentBalance" class="form-input" placeholder="í˜„ì¬ í†µì¥ ì”ì•¡">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ’³ ì´ˆê¸° ì”ì•¡</label>
                <input type="number" id="editInitialBalance" class="form-input" placeholder="ì´ˆê¸° ê¸ˆì•¡">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ’¸ ì‚¬ìš© ê¸ˆì•¡</label>
                <input type="number" id="editUsedAmount" class="form-input" placeholder="ì‚¬ìš©í•œ ê¸ˆì•¡">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ’µ ì´ì</label>
                <input type="number" id="editInterest" class="form-input" placeholder="ëˆ„ì  ì´ì">
            </div>
            <button class="btn btn-purple" onclick="window.saveBalanceEdit()">ì €ì¥</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrDf_2RemKIrYPgDvguHxKX-BuA78Zlrc",
            authDomain: "hochul-dasol-14ce0.firebaseapp.com",
            databaseURL: "https://hochul-dasol-14ce0-default-rtdb.firebaseio.com",
            projectId: "hochul-dasol-14ce0",
            storageBucket: "hochul-dasol-14ce0.firebasestorage.app",
            messagingSenderId: "566145273897",
            appId: "1:566145273897:web:a2ecd7935d19eefe238c38"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const budgetRef = ref(database, 'budget');

        let state = {
            activeTab: 'paid',
            paidItems: [
                { id: 1, date: '3/25', amount: -550000, category: 'ì‹ì¥', note: 'ê³„ì•½ê¸ˆ', checked: true },
                { id: 2, date: '5/10', amount: -500000, category: 'ì‹ í˜¼ì—¬í–‰', note: 'ê³„ì•½ê¸ˆ', checked: true },
                { id: 3, date: '5/16', amount: -4200000, category: 'ì‹ í˜¼ì—¬í–‰', note: 'ì´ë„ê¸ˆ, í•­ê³µë£Œ', checked: true },
                { id: 4, date: '7/4', amount: -1100000, category: 'ìŠ¤íŠœë””ì˜¤', note: 'ì´ë„ê¸ˆ', checked: true },
                { id: 5, date: '7/12', amount: -960000, category: 'ë·”í˜', note: 'ì´ë„ê¸ˆ', checked: true },
                { id: 6, date: '7/13', amount: -440000, category: 'ìŠ¤íŠœë””ì˜¤', note: 'ì‚¬ì§„ì›ë³¸ë¹„, ì´¬ì˜í—¬í¼ë¹„', checked: true },
                { id: 7, date: '9/14', amount: -490000, category: 'ìŠ¤íŠœë””ì˜¤', note: 'ì•¨ë²”í˜ì´ì§€ì¶”ê°€ë¹„, ì•¡ìë¹„', checked: true },
            ],
            upcomingItems: [
                { id: 2, date: '11/2', amount: -600000, category: 'ë°ì´íŠ¸', note: '11ì›” ë°ì´íŠ¸ ë¹„ìš©', checked: false },
                { id: 3, date: '10/25', amount: -26200, category: 'ì²­ì²©ì¥', note: 'ì¢…ì´ ì²­ì²©ì¥ (ë¹„ì¦ˆí•˜ìš°ìŠ¤)', checked: false },
                { id: 4, date: '10/25', amount: -6000, category: 'ì²­ì²©ì¥', note: 'ì²­ì²©ì¥ ë´‰íˆ¬ (ë‹¤ì´ì†Œ)', checked: false },
                { id: 5, date: '10/25', amount: -1000, category: 'ì²­ì²©ì¥', note: 'ì²­ì²©ì¥ ìŠ¤í‹°ì»¤ (ë‹¤ì´ì†Œ)', checked: false },
                { id: 6, date: '10/28', amount: -9400, category: 'ì²­ì²©ì¥', note: 'ëª¨ë°”ì¼ ì²­ì²©ì¥ (í”„ë¡ íˆ¬ë°ì´)', checked: false },
                { id: 7, date: 'ë¯¸ì •', amount: 0, category: 'ì‚¬íšŒì', note: '250,000~300,000', checked: false },
                { id: 8, date: 'ë¯¸ì •', amount: -300000, category: 'ì¶”ì²¨ì´ë²¤íŠ¸', note: '300,000', checked: false },
                { id: 9, date: 'ë¯¸ì •', amount: -3200000, category: 'ì‹ì¥ì”ê¸ˆ', note: 'ì‹ì¥ì”ê¸ˆ (ì¶•ì˜ê¸ˆ)', checked: false },
                { id: 10, date: 'ë¯¸ì •', amount: 0, category: 'ë·”í˜', note: 'ë·”í˜ ëˆ (ì¶•ì˜ê¸ˆ): ë¯¸ì •', checked: false },
                { id: 11, date: 'ë¯¸ì •', amount: -4340000, category: 'ì‹ í˜¼ì—¬í–‰', note: 'ì‹ í˜¼ì—¬í–‰ ì”ê¸ˆ: 4,340,000', checked: false },
                { id: 12, date: 'ë¯¸ì •', amount: 0, category: 'ì‹ í˜¼ì—¬í–‰', note: 'ì‹ í˜¼ì—¬í–‰ ê²½ë¹„: 5,000,000~6,000,000', checked: false },
                { id: 13, date: 'ë¯¸ì •', amount: 0, category: 'ì‹ ë¶€', note: 'ì‹ ë¶€ ë“œë ˆìŠ¤: íŒ¨í‚¤ì§€ í¬í•¨, ì¶”ê°€ê¸ˆ ë“¤ìˆ˜ìˆìŒ', checked: false },
                { id: 14, date: 'ë¯¸ì •', amount: 0, category: 'ì‹ ë‘', note: 'ì‹ ë‘ ì–‘ë³µ: íŒ¨í‚¤ì§€ í¬í•¨, ì¶”ê°€ê¸ˆ ë“¤ìˆ˜ìˆìŒ', checked: false },
                { id: 15, date: 'ë¯¸ì •', amount: 0, category: 'ì‹ ë¶€', note: 'ì‹ ë¶€ êµ¬ë‘: íŒ¨í‚¤ì§€ í¬í•¨', checked: false },
                { id: 16, date: 'ë¯¸ì •', amount: 0, category: 'ì‹ ë‘', note: 'ì‹ ë‘ êµ¬ë‘: ê°œì¸ ì¤€ë¹„, ëŒ€ì—¬í•  ì‹œ ì¶”ê°€ê¸ˆ 3ë§Œì›', checked: false },
                { id: 17, date: 'ë¯¸ì •', amount: -550000, category: 'ì‹ ë‘,ì‹ ë¶€', note: 'ì‹ ë‘,ì‹ ë¶€ í•œë³µ: 550,000 (ì‹ ë°œ í¬í•¨)', checked: false },
                { id: 18, date: 'ë¯¸ì •', amount: -550000, category: 'ì–‘ê°€', note: 'ì–‘ê°€ ì–´ë¨¸ë‹˜ í•œë³µ: 550,000 (ì‹ ë°œ í¬í•¨)', checked: false },
                { id: 19, date: 'ë¯¸ì •', amount: 0, category: 'ì–‘ê°€', note: 'ì–‘ê°€ ì•„ë²„ë‹˜ ì–‘ë³µ: ëˆ ë“¬ (êµ¬ë‘ ì•Œì•„ë´ì•¼í•¨)', checked: false },
            ],
            initialBalance: 10000000,
            usedAmount: 0,
            totalInterest: 0,
            showAddForm: false,
            editingId: null,
            editingType: null,
            editingData: null
        };

        let isUpdatingFromFirebase = false;

        // ë‚ ì§œë¥¼ ë¹„êµ ê°€ëŠ¥í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function parseDateForSort(dateStr) {
            // "ë¯¸ì •"ì€ ê°€ì¥ ë§ˆì§€ë§‰ìœ¼ë¡œ
            if (dateStr === 'ë¯¸ì •' || dateStr === '' || !dateStr) {
                return 99991231;
            }
            
            // "3/25" í˜•ì‹ì„ "20250325" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const parts = dateStr.split('/');
            if (parts.length === 2) {
                const month = parts[0].padStart(2, '0');
                const day = parts[1].padStart(2, '0');
                return parseInt('2025' + month + day);
            }
            
            return 99991231;
        }

        // í•­ëª©ë“¤ì„ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
        function sortItemsByDate(items) {
            return items.sort((a, b) => {
                const dateA = parseDateForSort(a.date);
                const dateB = parseDateForSort(b.date);
                return dateA - dateB;
            });
        }

        function updateSyncStatus(status, message) {
            const el = document.getElementById('syncStatus');
            if (status === 'syncing') {
                el.innerHTML = 'ğŸ”„ ' + (message || 'ë™ê¸°í™” ì¤‘...');
                el.className = 'sync-status syncing';
            } else if (status === 'synced') {
                el.innerHTML = 'âœ… ' + (message || 'ë™ê¸°í™” ì™„ë£Œ');
                el.className = 'sync-status synced';
            } else if (status === 'error') {
                el.innerHTML = 'âš ï¸ ' + (message || 'ì—°ê²° ì˜¤ë¥˜');
                el.className = 'sync-status error';
            }
        }

        function saveToFirebase() {
            if (isUpdatingFromFirebase) return;
            
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            
            // ì €ì¥í•˜ê¸° ì „ì— ì •ë ¬
            state.paidItems = sortItemsByDate(state.paidItems);
            state.upcomingItems = sortItemsByDate(state.upcomingItems);
            
            const data = {
                paidItems: state.paidItems,
                upcomingItems: state.upcomingItems,
                initialBalance: state.initialBalance,
                usedAmount: state.usedAmount,
                totalInterest: state.totalInterest,
                lastUpdated: Date.now()
            };
            
            set(budgetRef, data)
                .then(() => {
                    updateSyncStatus('synced', 'ì €ì¥ ì™„ë£Œ');
                    setTimeout(() => updateSyncStatus('synced', 'ì‹¤ì‹œê°„ ì—°ê²°'), 1000);
                })
                .catch((error) => {
                    console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                    updateSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                });
        }

        onValue(budgetRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                isUpdatingFromFirebase = true;
                state.paidItems = sortItemsByDate(data.paidItems || state.paidItems);
                state.upcomingItems = sortItemsByDate(data.upcomingItems || state.upcomingItems);
                state.initialBalance = data.initialBalance || state.initialBalance;
                state.usedAmount = data.usedAmount || 0;
                state.totalInterest = data.totalInterest || 0;
                render();
                updateSyncStatus('synced', 'ì‹¤ì‹œê°„ ì—°ê²°');
                setTimeout(() => { isUpdatingFromFirebase = false; }, 100);
            } else {
                saveToFirebase();
            }
        }, (error) => {
            console.error('Firebase ì—°ê²° ì˜¤ë¥˜:', error);
            updateSyncStatus('error', 'ì—°ê²° ì˜¤ë¥˜');
        });

        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(Math.abs(num));
        }

        function calculateTotal(items) {
            return items.reduce((sum, item) => sum + (item.amount || 0), 0);
        }

        function calculateUncheckedTotal(items) {
            const total = items.filter(item => !item.checked).reduce((sum, item) => sum + (item.amount || 0), 0);
            return Math.abs(total);
        }

        function toggleCheck(id, type) {
            const items = type === 'paid' ? state.paidItems : state.upcomingItems;
            const item = items.find(i => i.id === id);
            if (item) {
                const wasChecked = item.checked;
                item.checked = !item.checked;
                
                // ì˜ˆì • ì§€ì¶œ íƒ­ì—ì„œë§Œ ì‚¬ìš©ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                if (type === 'upcoming' && item.amount !== 0) {
                    if (item.checked) {
                        // ì²´í¬: ì‚¬ìš©ê¸ˆì•¡ ì¦ê°€
                        state.usedAmount += Math.abs(item.amount);
                    } else {
                        // ì²´í¬ í•´ì œ: ì‚¬ìš©ê¸ˆì•¡ ê°ì†Œ
                        state.usedAmount -= Math.abs(item.amount);
                    }
                }
                
                saveToFirebase();
                render();
            }
        }

        function deleteItem(id, type) {
            if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            if (type === 'paid') {
                state.paidItems = state.paidItems.filter(i => i.id !== id);
            } else {
                const item = state.upcomingItems.find(i => i.id === id);
                if (item && item.checked && item.amount !== 0) {
                    state.usedAmount -= Math.abs(item.amount);
                }
                state.upcomingItems = state.upcomingItems.filter(i => i.id !== id);
            }
            saveToFirebase();
            render();
        }

        function startEdit(id, type) {
            const items = type === 'paid' ? state.paidItems : state.upcomingItems;
            const item = items.find(i => i.id === id);
            if (item) {
                state.editingId = id;
                state.editingType = type;
                state.editingData = { ...item };
                render();
            }
        }

        function cancelEdit() {
            state.editingId = null;
            state.editingType = null;
            state.editingData = null;
            render();
        }

        function saveEdit() {
            if (!state.editingData) return;
            const items = state.editingType === 'paid' ? state.paidItems : state.upcomingItems;
            const index = items.findIndex(i => i.id === state.editingId);
            if (index !== -1) {
                const oldItem = items[index];
                const newItem = { ...state.editingData };
                
                // ì˜ˆì • ì§€ì¶œì´ê³  ì²´í¬ëœ í•­ëª©ì˜ ê¸ˆì•¡ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ì‚¬ìš©ê¸ˆì•¡ ì¡°ì •
                if (state.editingType === 'upcoming' && oldItem.checked) {
                    state.usedAmount -= Math.abs(oldItem.amount);
                    state.usedAmount += Math.abs(newItem.amount);
                }
                
                items[index] = newItem;
            }
            state.editingId = null;
            state.editingType = null;
            state.editingData = null;
            saveToFirebase();
            render();
        }

        function updateEditField(field, value) {
            if (state.editingData) {
                if (field === 'amount') {
                    const num = parseInt(value) || 0;
                    state.editingData[field] = num === 0 ? 0 : -Math.abs(num);
                } else {
                    state.editingData[field] = value;
                }
            }
        }

        function addItem() {
            const date = document.getElementById('newDate').value;
            const category = document.getElementById('newCategory').value;
            const amount = parseInt(document.getElementById('newAmount').value) || 0;
            const note = document.getElementById('newNote').value;

            if (!date || !category) {
                alert('ë‚ ì§œì™€ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤!');
                return;
            }

            const finalAmount = amount === 0 ? 0 : -Math.abs(amount);
            const item = { id: Date.now(), date, category, amount: finalAmount, note, checked: false };
            if (state.activeTab === 'paid') {
                state.paidItems.push(item);
            } else {
                state.upcomingItems.push(item);
            }
            state.showAddForm = false;
            saveToFirebase();
            render();
        }

        function openEditModal() {
            const currentBalance = state.initialBalance + state.totalInterest - state.usedAmount;
            document.getElementById('editCurrentBalance').value = currentBalance;
            document.getElementById('editInitialBalance').value = state.initialBalance;
            document.getElementById('editUsedAmount').value = state.usedAmount;
            document.getElementById('editInterest').value = state.totalInterest;
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        function saveBalanceEdit() {
            const newInitialBalance = parseInt(document.getElementById('editInitialBalance').value) || 0;
            const newUsedAmount = parseInt(document.getElementById('editUsedAmount').value) || 0;
            const newInterest = parseInt(document.getElementById('editInterest').value) || 0;
            
            state.initialBalance = newInitialBalance;
            state.usedAmount = newUsedAmount;
            state.totalInterest = newInterest;
            
            closeEditModal();
            saveToFirebase();
            render();
        }

        function addInterest() {
            const interest = parseInt(prompt('ì´ì ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ìŒìˆ˜ ì…ë ¥ ì‹œ ì°¨ê°):', ''));
            if (!isNaN(interest) && interest !== 0) {
                state.totalInterest += interest;
                saveToFirebase();
                render();
                if (interest > 0) {
                    alert(`ì´ì ${formatNumber(interest)}ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\nëˆ„ì  ì´ì: ${formatNumber(state.totalInterest)}ì›`);
                } else {
                    alert(`ì´ì ${formatNumber(interest)}ì›ì´ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤!\nëˆ„ì  ì´ì: ${formatNumber(state.totalInterest)}ì›`);
                }
            }
        }

        function render() {
            const items = sortItemsByDate(state.activeTab === 'paid' ? state.paidItems : state.upcomingItems);
            const total = Math.abs(calculateTotal(items));
            const uncheckedTotal = calculateUncheckedTotal(state.upcomingItems);
            const currentBalance = state.initialBalance + state.totalInterest - state.usedAmount;

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="header-top">
                            <div>
                                <h1>ğŸ’‘ ê²°í˜¼ ì¤€ë¹„ ì˜ˆì‚° ê´€ë¦¬</h1>
                                <div class="header-subtitle">ì²´ê³„ì ì¸ ê²°í˜¼ ì¤€ë¹„ë¥¼ ìœ„í•œ ì˜ˆì‚° íŠ¸ë˜ì»¤</div>
                            </div>
                        </div>
                        <div class="header-note">ğŸ’• ëª¨ë“  ê¸°ê¸°ì—ì„œ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤</div>
                    </div>

                    <div class="tabs">
                        <button class="tab ${state.activeTab === 'paid' ? 'active' : ''}" onclick="window.switchTab('paid')">âœ… ì§€ì¶œ ì™„ë£Œ</button>
                        <button class="tab ${state.activeTab === 'upcoming' ? 'active' : ''}" onclick="window.switchTab('upcoming')">ğŸ“‹ ì˜ˆì • ì§€ì¶œ</button>
                    </div>

                    <div class="content">
                        ${state.activeTab === 'paid' ? `
                            <div class="card card-gradient-red">
                                <div class="card-label">ì§€ê¸ˆê¹Œì§€ ì“´ ëˆ</div>
                                <div class="card-amount">-${formatNumber(total)}ì›</div>
                            </div>
                        ` : `
                            <div class="card card-gradient-green">
                                <div class="card-header">
                                    <div class="card-label">ğŸ’° í†µì¥ ì”ì•¡</div>
                                    <div>
                                        <button class="btn btn-white" style="padding: 6px 12px; font-size: 12px;" onclick="window.openEditModal()">ìˆ˜ì •</button>
                                        <button class="btn btn-green" style="padding: 6px 12px; font-size: 12px;" onclick="window.addInterest()">ğŸ’µ ì´ì</button>
                                    </div>
                                </div>
                                <div class="card-amount">${formatNumber(currentBalance)}ì›</div>
                                <div class="card-note">
                                    <span class="card-note-item">ğŸ’³ ì´ˆê¸°: ${formatNumber(state.initialBalance)}ì›</span>
                                    <span class="card-note-item">ğŸ’¸ ì‚¬ìš©: ${formatNumber(state.usedAmount)}ì›</span>
                                    <span class="card-note-item">ğŸ’µ ì´ì: ${state.totalInterest >= 0 ? '+' : ''}${formatNumber(state.totalInterest)}ì›</span>
                                </div>
                            </div>
                            <div class="card card-gradient-blue">
                                <div class="card-label">ì•ìœ¼ë¡œ ì“¸ ëˆ (ì²´í¬ ì•ˆëœ í•­ëª©)</div>
                                <div class="card-amount">-${formatNumber(uncheckedTotal)}ì›</div>
                            </div>
                        `}

                        ${state.showAddForm ? `
                            <div class="form-card">
                                <div class="form-header">
                                    <div class="form-title">ìƒˆ í•­ëª© ì¶”ê°€</div>
                                    <button class="form-close" onclick="window.closeAddForm()">&times;</button>
                                </div>
                                <div class="form-group"><input type="text" id="newDate" placeholder="ë‚ ì§œ (ì˜ˆ: 3/25 ë˜ëŠ” 11/15)" class="form-input"></div>
                                <div class="form-group"><input type="text" id="newCategory" placeholder="ì¹´í…Œê³ ë¦¬" class="form-input"></div>
                                <div class="form-group"><input type="number" id="newAmount" placeholder="ê¸ˆì•¡ (ìˆ«ìë§Œ ì…ë ¥)" class="form-input"></div>
                                <div class="form-group"><input type="text" id="newNote" placeholder="ë©”ëª¨" class="form-input"></div>
                                <button class="btn btn-purple" onclick="window.addItem()">ì¶”ê°€í•˜ê¸°</button>
                            </div>
                        ` : `
                            <button class="btn-add" onclick="window.openAddForm()"><span style="font-size: 20px;">â•</span> ìƒˆ í•­ëª© ì¶”ê°€</button>
                        `}

                        ${items.map(item => {
                            const isEditing = state.editingId === item.id && state.editingType === state.activeTab;
                            const displayItem = isEditing ? state.editingData : item;
                            return `
                            <div class="item ${item.checked ? 'checked' : ''}">
                                <div class="item-checkbox" onclick="window.toggleCheck(${item.id}, '${state.activeTab}')">${item.checked ? 'âœ“' : ''}</div>
                                <div class="item-content">
                                    ${isEditing ? `
                                        <div class="item-header" style="margin-bottom: 8px;">
                                            <input type="text" value="${displayItem.date}" oninput="window.updateEditField('date', this.value)" class="form-input" style="width: 80px; padding: 6px 8px; font-size: 14px;">
                                            <input type="text" value="${displayItem.category}" oninput="window.updateEditField('category', this.value)" class="form-input" style="flex: 1; padding: 6px 8px; font-size: 14px;">
                                        </div>
                                        <input type="number" value="${Math.abs(displayItem.amount)}" oninput="window.updateEditField('amount', this.value)" class="form-input" style="margin-bottom: 8px; padding: 6px 8px;" placeholder="ê¸ˆì•¡ (ìˆ«ìë§Œ)">
                                        <input type="text" value="${displayItem.note}" oninput="window.updateEditField('note', this.value)" class="form-input" style="padding: 6px 8px; font-size: 14px;">
                                    ` : `
                                        <div class="item-header">
                                            <span class="item-date">${displayItem.date}</span>
                                            <span class="item-category">${displayItem.category}</span>
                                        </div>
                                        <div class="item-amount ${displayItem.amount === 0 ? 'zero' : ''}">
                                            ${displayItem.amount !== 0 ? '-' + formatNumber(displayItem.amount) + 'ì›' : 'ê¸ˆì•¡ ë¯¸ì •'}
                                        </div>
                                        <div class="item-note">${displayItem.note}</div>
                                    `}
                                </div>
                                <div class="item-actions">
                                    ${isEditing ? `
                                        <button class="item-edit" onclick="window.saveEdit()">âœ…</button>
                                        <button class="item-edit" onclick="window.cancelEdit()">âŒ</button>
                                    ` : `
                                        <button class="item-edit" onclick="window.startEdit(${item.id}, '${state.activeTab}')">âœï¸</button>
                                        <button class="item-delete" onclick="window.deleteItem(${item.id}, '${state.activeTab}')">ğŸ—‘ï¸</button>
                                    `}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        window.toggleCheck = toggleCheck;
        window.deleteItem = deleteItem;
        window.startEdit = startEdit;
        window.cancelEdit = cancelEdit;
        window.saveEdit = saveEdit;
        window.updateEditField = updateEditField;
        window.addItem = addItem;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveBalanceEdit = saveBalanceEdit;
        window.addInterest = addInterest;
        window.switchTab = (tab) => { state.activeTab = tab; render(); };
        window.openAddForm = () => { state.showAddForm = true; render(); };
        window.closeAddForm = () => { state.showAddForm = false; render(); };

        render();
    </script>
</body>
</html>